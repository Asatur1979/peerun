# Архитектурка.


## Система ключей.

### Описание
Мы активно эксплуатируем bip32 (HD wallet) и bip44 (описание пути) для генерации ключей.
todo: Надо уточнить как у этой дряни с квантовыми компами. В плане есть ли квантоустойчивые алгоритмы, позволяющие сделать xpubkey ключ для генерации дочерних ключей.

Генерируем стандартный сид. Кодируем его в 12-словную фразу. Фразу принуждаем пользователя записать потому что она не хранится и служит для резервного доступа.
Далее запись согласно bip44 генерируем гору ключей (смотри ниже)

### Разные типа ключей

* m/44'/60'/0'/0/0 - из коробки получаем адрес для приватного кошелька эфира.
* m/44'/X'/0 - резервный ключ восстановления. тоже нигде не хранится. [Здесь и далее X - номер нашего проект]
* m/44'/X'/0/0 [N1] главный приватный ключ нашей учётной записи.  Он хранится (или не хранится если это временное устройство например) под пинкодом на устройстве и большую часть времени не нужен.
* M/44'/X'/0/0 [N2] главный публичный ключ. является по сути лицом нашей записи. ну там в блокчейне на неё будем ники навешивать, био в ipns складывать.
* m/44'/X'/0/0/0 [N3] - ключ используемый для переписки. с помощью него происходит dh, подписи и прочие штуки. По идее ротируемы профилактически или при подозрении в компрометации.
* M/44'/X'/0/0/0 [N4] - его публичная пара
* m/44'/X'/0/0/0/n [N5] - приватные ключи устройств. позволяют принимать сообщения от твоего имени с обещанием передать получателю.
* M/44'/X'/0/0/0/n [N6] - Публичные ключи устройст. Через них девайсы одного пользователя находят друг друга. являются айди в libp2p.
* m/44'/X'/0/0/1/n - публичные каналы. (может есть смысл как-то разнести их с ключами используемыми для переписки)
* m/44'/X'/0/0/1/n' - анонимные каналы.
* m/44'/X'/0/0' - могут быть скрытые учетки без возможности восстановления через резервный ключ. Для их создания требуется сид-фраза.

Это всё является ключами на которые можно получать деньги. например владельцу анонимного канала можно отсыпать донатов. или послать деньги человеку или сделать это на адрес публичного канала чтобы сразу ясно за что.

#### Замечания

Альтернативой делегирования прокси нод через передачу ключей N5 может быть указание на конкретную ноду с подписью N1 (и сроком действия), пошареное в ipns или блокчейн. Но это на более поздних стадиях, имхо.

### Резервный ключ
В случае если пользователь проебет главный приватный ключ учётки, то он по фразе восстановит резервный, а им сделает запись в блокчейне "извините, ключ M/44'/X'/0/0 скомпрометирован - смотрите ключ M/44'/X'/0/1".
При этом для анонимных и публичных каналов можно сделать отдельные записи в блокчейне так как по их ключам нельзя всегда получить владельца.

### Мысль про каналы
Тут были разговоры про платные каналы. Возможно архитектура их будет существенно другая. что-то типа ботов.


# Как это всё работает.

## Написать человеку разовое письмо (оно же запросить добавление в белый список).

1. Борис получает публичный ключ Алисы N2 по какому-то каналу (резолвит wonder_alice в блокчейне/считывает qr код с визитки или приложения/получает по телеграму base58 или любой другой способ).
1.1. Борис проверяет в блокчейне наличие записей о компрометации и если такие есть сразу заменяет N2 на то что указано как новый адрес в БЧ.
2. Борис генерирует ключи N6 из N2 и начинает их искать в libp2p в целях установить соединение.
2.1. Если не находит ничего, то просто ждёт и продолжает иногда простукивать.
2.2. Если находит, то...
2.2.1. Проверяет блокчейн и другие найденные ноды на предмет не в чёрном списке ли эта (подпись черных списков ключем N1 или N3)
2.2.2. спрашивает какие критерии прохождения спам контроля (объем PoW или сумму токенов)
2.2.3. подписывает сообщение своим ключем N3, шифрует ключем N4 Алисы и отправляет ноде на хранение сопроводив pow или котлетой валюты на N2.
3. Ноды Алисы друг друга видят и синхронизируют сообщение между собой.
4. Алиса расшифровывает сообщение ключем N3 и читает.
5. Алиса опционально добавляет Бориса в белый список чтобы не требовать PoW/деньги. Ну или наоборот повышает плату в 10 раз агагага!

## Установить постоянный чат

до 2.2.1 включительно как в предыдущем пункте.
Дальше всё отличается. Во-первых требуется нахождение в белом списке.
Боб ищет среди нод Алисы ту у которой есть ключ N3 и она онлайн. Находит, с помощью ключей N3 делает dh и получают сессионный ключ.
Потом также шарит этот ключ между своими девайсами. в дальнейшем собщения шифруются сессионным ключем и доставляются через ноды алисы.

## Каналы

По сути ключ канала - ключ ipns, а записи просто текстовые файлы сквозной нумерации


## Белый список

Vожет иметь два не взаимоисключающих варианта:
1. все ноды алисы синхронизируют список
2. боб имеет подписанное N3 утверждение, что он в белом списке

## О интеграция с email и человеческих именах

я пока не отполировал, но работаю над этим.

1. довольно очевидная мысль, что человекочитаемые имена это ценный ресурс который стоит распределять через блокчейн.
2. стоит взять имена вида user@domain. во-первых это привычно. во-вторых позволит разделить зоны ответственности по источникам логинов чтобы обеспечить обратную совместимость с миллиардами существующих на данный момент в мире логинов.
3. самый простой случай. у нас есть юзеры с именами вида e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.  без собачек и прочего. это хэш публичного ключа, который он там пошарит через ipfs
4. чуть более сложный случай. делаем смартконтракт N1 в нашем сайдчейне, который позволяет за токены регать ники (возможно с абоненткой для коротких или типа того и просто необходимостью потвердить раз в год что ты живой для остальных). делаем другой смартконтракт N2 для доменов (вероятно для начала без свободной регистрации) в котором пишем что за пользователями домена peerun отвечает - вон тот контракт N1.
5. это смартконтрак разрешает регать (вероятно через подтверждение нескольких ээээ... оракулов? я не силен в терминологии блокчейна) на контракте N2 для доменов обычные домены из старой системы днс. При этом ссылаясь на другие смартконтракты для резолва доменов. Условно протонмэил через оракулов валидирует что владеет доменом. Делает свой контракт и свободно вносит своих юзеров и менеджит их.
6. Получаем мапинг имеющихся контактов типа как счас в телеге. (кстати аналогичную конструкцию можно прикрутить и для телефонов - тоже домен @msisdn, контракт, оракулы)
7. ну и возможно прокси через сервера если например один клиент в нашем мессенджере, а другой нет, то можно сделать vasya@protonmail.com из приложения пирун пишет serege@tutanota.com и напрямую связывается с сервером tutanota.com по протоколу peerun и сереже падает в ящик уже обычное мыло. ну и наоборот. но это надо ещё обдумать а я не обдумал

### Мысли

Вероятно есть смысл дать возможность хранить в смартконтрактах как имена напрямую так и только хэши имен. у обоих подходов есть как плюсы так и минусы. наверное должно определяться типом контракта.

## корпоративные учётки и подробнее о сообщениях

В процессе написания.